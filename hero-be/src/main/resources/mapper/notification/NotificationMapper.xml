<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.c4.hero.domain.notification.mapper.NotificationMapper">
    
    <resultMap id="notificationResultMap" type="com.c4.hero.domain.notification.dto.NotificationDTO">
        <id property="notificationId" column="notification_id"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="message" column="message"/>
        <result property="link" column="link"/>
        <result property="isRead" column="is_read"/>
        <result property="createdAt" column="created_at"/>
        <result property="readAt" column="read_at"/>
        <result property="employeeId" column="employee_id"/>
        <result property="attendanceId" column="attendance_id"/>
        <result property="payrollId" column="payroll_id"/>
        <result property="documentId" column="document_id"/>
        <result property="evaluationId" column="evaluation_id"/>
    </resultMap>

    <insert id="insertNotification" parameterType="com.c4.hero.domain.notification.dto.NotificationDTO">
        INSERT INTO tbl_notifications (
            type,
            title,
            message,
            link,
            is_read,
            created_at,
            employee_id,
            attendance_id,
            payroll_id,
            document_id,
            evaluation_id
        ) VALUES (
            #{type},
            #{title},
            #{message},
            #{link},
            false,
            NOW(),
            #{employeeId},
            #{attendanceId},
            #{payrollId},
            #{documentId},
            #{evaluationId}
        );
    </insert>

    <!-- 알림 목록 조회 -->
    <select id="selectAllNotification" resultMap="notificationResultMap" parameterType="int">
        SELECT *
          FROM tbl_notifications
         WHERE employee_id = #{employeeId}
         ORDER BY created_at DESC
    </select>

    <!-- 미읽은 알림 개수 조회 -->
    <select id="countUnreadNotification" resultType="int" parameterType="int">
        SELECT COUNT(*)
          FROM tbl_notifications
         WHERE employee_id = #{employeeId}
           AND is_read = false;
    </select>

    <!-- 알림 읽음 처리 -->
    <update id="updateIsRead" parameterType="int">
        UPDATE tbl_notifications
           SET is_read = true,
               read_at = NOW()
         WHERE employee_id = #{employeeId}
           AND is_read = false;
    </update>

    <!-- 모든 알림 읽음 처리 -->
    <update id="updateAllIsRead" parameterType="int">
        UPDATE tbl_notifications
           SET is_read = true,
               read_at = NOW()
         WHERE employee_id = #{employeeId}
           AND is_read = false;
    </update>
</mapper>