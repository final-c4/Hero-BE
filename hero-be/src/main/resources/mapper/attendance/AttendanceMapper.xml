<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    ============================================================
    File Name  : AttendanceMapper.xml
    Description: 근태(Attendance) 관련 데이터를 조회하는 MyBatis 매퍼 XML

    History
    2025/12/09 (이지윤) 최초 작성 및 컨벤션 적용
    ============================================================
-->

<mapper namespace="com.c4.hero.domain.attendance.mapper.AttendanceMapper">

    <!-- ============================================================
         1) 개인 근태 기록 ResultMap
            PersonalDTO 매핑 정의
         ============================================================ -->
    <resultMap id="PersonalMap" type="com.c4.hero.domain.attendance.dto.PersonalDTO">
        <result property="attendanceId"   column="attendance_id"/>
        <result property="workDate"       column="work_date"/>
        <result property="state"          column="state"/>
        <result property="startTime"      column="start_time"/>
        <result property="endTime"        column="end_time"/>
        <result property="workDuration"   column="work_duration"/>
        <result property="workSystemName" column="work_system_name"/>
    </resultMap>

    <resultMap id="OvertimeMap" type="com.c4.hero.domain.attendance.dto.OvertimeDTO">
        <result property="overtimeId" column="overtime_id"/>
        <result property="date" column="date"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="overtimeHours" column="overtime_hours"/>
        <result property="reason" column="reason"/>
    </resultMap>

    <!-- ============================================================
         2) 개인 근태 기록 SELECT (페이지 조회)
            AttendanceMapper.selectPersonalPage(...)
         ============================================================ -->
    <select id="selectPersonalPage" resultMap="PersonalMap" parameterType="map">
        SELECT
        att.attendance_id,
        att.work_date,
        att.state,
        att.start_time,
        att.end_time,
        COALESCE(
        TIMESTAMPDIFF(MINUTE, att.start_time, att.end_time),
        0
        ) AS work_duration,
        wst.name AS work_system_name
        FROM tbl_attendance att
        JOIN tbl_work_system_type wst
        ON att.work_system_type_id = wst.work_system_type_id
        <where>
            <if test="startDate != null and startDate != ''">
                AND att.work_date &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND att.work_date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY att.work_date DESC, att.attendance_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ============================================================
         3) 개인 근태 기록 총 개수 조회
            AttendanceMapper.selectPersonalCount(...)
         ============================================================ -->
    <select id="selectPersonalCount" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM tbl_attendance att
        JOIN tbl_work_system_type wst
        ON att.work_system_type_id = wst.work_system_type_id
        <where>
            <if test="startDate != null and startDate != ''">
                AND att.work_date &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND att.work_date &lt;= #{endDate}
            </if>
        </where>
    </select>

    <select id="selectOvertimePage" resultMap="OvertimeMap">
        SELECT
            ove.overtime_id,
            ove.date,
            ove.start_time,
            ove.end_time,
            ove.overtime_hours,
            ove.reason
          FROM tbl_overtime ove
    </select>

</mapper>
