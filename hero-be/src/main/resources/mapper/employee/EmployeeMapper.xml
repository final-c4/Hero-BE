<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.c4.hero.domain.employee.mapper.EmployeeMapper">

    <resultMap id="EmployeeResultMap" type="com.c4.hero.domain.employee.entity.Employee">
        <id property="employeeId" column="employee_id"/>
        <result property="employeeNumber" column="employee_number"/>
        <result property="employeeName" column="employee_name"/>
        <result property="email" column="email" typeHandler="org.apache.ibatis.type.ByteArrayTypeHandler"/>
        <result property="phone" column="phone" typeHandler="org.apache.ibatis.type.ByteArrayTypeHandler"/>
        <result property="birthDate" column="birth_date"/>
        <result property="gender" column="gender"/>
        <result property="status" column="status" typeHandler="com.c4.hero.domain.employee.type.handler.EmployeeStatusTypeHandler"/>
        <result property="contractType" column="contract_type"/>
        <result property="address" column="address" typeHandler="org.apache.ibatis.type.ByteArrayTypeHandler"/>
        <result property="hireDate" column="hire_date"/>
        <result property="terminationDate" column="termination_date"/>
        <result property="retentionExpireAt" column="retention_expire_at"/>
        <result property="sealImageUrl" column="seal_image_url"/>
        <result property="imagePath" column="image_path"/>
        <result property="evaluationPoint" column="evaluation_point"/>
        <result property="baseSalary" column="base_salary"/>

        <!-- 연관 관계 매핑 -->
        <association property="employeeDepartment" javaType="com.c4.hero.domain.employee.entity.EmployeeDepartment">
            <id property="departmentId" column="department_id"/>
            <result property="departmentName" column="department_name"/>
        </association>
        
        <association property="grade" javaType="com.c4.hero.domain.employee.entity.Grade">
            <id property="gradeId" column="grade_id"/>
            <result property="grade" column="grade_name"/>
        </association>
        
        <association property="jobTitle" javaType="com.c4.hero.domain.employee.entity.JobTitle">
            <id property="jobTitleId" column="job_title_id"/>
            <result property="jobTitle" column="job_title_name"/>
        </association>
    </resultMap>

    <!-- 부서 경로를 포함하는 ResultMap -->
    <resultMap id="EmployeeWithDeptPathResultMap" type="com.c4.hero.domain.employee.entity.Employee" extends="EmployeeResultMap">
        <result property="departmentPath" column="department_path"/>
    </resultMap>

    <sql id="employeeColumns">
        e.employee_id, e.employee_number, e.employee_name, e.email, e.phone,
        e.birth_date, e.gender, e.status, e.contract_type, e.address,
        e.hire_date, e.image_path, e.evaluation_point,
        d.department_id, d.department_name,
        g.grade_id, g.grade AS grade_name,
        jt.job_title_id, jt.job_title AS job_title_name
    </sql>

    <sql id="employeeJoins">
        FROM
            tbl_employee e
        LEFT JOIN
            tbl_department d ON e.department_id = d.department_id
        LEFT JOIN
            tbl_grade g ON e.grade_id = g.grade_id
        LEFT JOIN
            tbl_job_title jt ON e.job_title_id = jt.job_title_id
    </sql>

    <sql id="searchConditions">
        <where>
            e.status = 'A'
            <if test="departmentName != null and departmentName != ''">
                AND d.department_name LIKE CONCAT('%', #{departmentName}, '%')
            </if>
            <if test="jobTitleName != null and jobTitleName != ''">
                AND jt.job_title LIKE CONCAT('%', #{jobTitleName}, '%')
            </if>
            <if test="gradeName != null and gradeName != ''">
                AND g.grade LIKE CONCAT('%', #{gradeName}, '%')
            </if>
            <if test="employeeName != null and employeeName != ''">
                AND e.employee_name LIKE CONCAT('%', #{employeeName}, '%')
            </if>
            <choose>
                <when test="resigningExpected == 1">
                    <!-- 미포함: 퇴사 예정이 아닌 직원만 -->
                    AND e.termination_date IS NULL
                </when>
                <when test="resigningExpected == 2">
                    <!-- 퇴사 예정자만 -->
                    AND e.termination_date IS NOT NULL
                </when>
                <!-- 그 외(0 또는 null): 모든 재직자(퇴사 예정자 포함) -->
            </choose>
        </where>
    </sql>

    <select id="findWithPaging" resultMap="EmployeeResultMap" parameterType="com.c4.hero.domain.employee.dto.request.EmployeeSearchDTO">
        SELECT
        <include refid="employeeColumns"/>
        <include refid="employeeJoins"/>
        <include refid="searchConditions"/>
        ORDER BY
            e.hire_date DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="count" resultType="int" parameterType="com.c4.hero.domain.employee.dto.request.EmployeeSearchDTO">
        SELECT COUNT(*)
        <include refid="employeeJoins"/>
        <include refid="searchConditions"/>
    </select>

    <select id="findById" resultMap="EmployeeWithDeptPathResultMap" parameterType="int">
        WITH RECURSIVE DepartmentPath AS (
            SELECT
                department_id,
                department_name,
                parent_department_id,
                CAST(department_name AS CHAR(255)) AS path
            FROM tbl_department
            WHERE parent_department_id IS NULL
            UNION ALL
            SELECT
                d.department_id,
                d.department_name,
                d.parent_department_id,
                CONCAT(dp.path, ' > ', d.department_name)
            FROM tbl_department d
            JOIN DepartmentPath dp ON d.parent_department_id = dp.department_id
        )
        SELECT
            e.employee_id, e.employee_number, e.employee_name, e.email, e.phone,
            e.birth_date, e.gender, e.status, e.contract_type, e.address,
            e.hire_date, e.image_path, e.evaluation_point, e.base_salary,
            e.termination_date, e.retention_expire_at, e.seal_image_url,
            d.department_id, d.department_name,
            g.grade_id, g.grade AS grade_name,
            jt.job_title_id, jt.job_title AS job_title_name,
            dp.path AS department_path
        FROM
            tbl_employee e
        LEFT JOIN
            tbl_department d ON e.department_id = d.department_id
        LEFT JOIN
            tbl_grade g ON e.grade_id = g.grade_id
        LEFT JOIN
            tbl_job_title jt ON e.job_title_id = jt.job_title_id
        LEFT JOIN
            DepartmentPath dp ON e.department_id = dp.department_id
        WHERE e.employee_id = #{employeeId}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </select>

    <select id="findAllDepartmentNames" resultType="string">
        SELECT DISTINCT department_name FROM tbl_department ORDER BY department_name
    </select>

    <select id="findAllGradeNames" resultType="string">
        SELECT DISTINCT grade FROM tbl_grade ORDER BY grade_id
    </select>

    <select id="findAllJobTitleNames" resultType="string">
        SELECT DISTINCT job_title FROM tbl_job_title ORDER BY job_title_id
    </select>

</mapper>